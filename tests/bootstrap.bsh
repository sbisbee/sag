#!/bin/bash

# Copyright 2011 Sam Bisbee
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# bootstrap.php
#
# Assumes that tests are independent from each another. That is, if one step
# fails then the other steps should still run.

numSteps=0
failures=0

function success
{
  echo "done."
}

function failure
{
  echo "FAIL!"
  ((failures++))
}

for cmd in curl phpunit 
do
  ((numSteps++))
  echo -e -n "checking for $cmd...\t\t\t\t"

  which $cmd > /dev/null

  [ $? -eq 0 ] && success || failure
done

((numSteps++))
echo -e -n "Checking for admin:passwd credentials...\t"
curl -s http://admin:passwd@localhost:5984/_session | grep 'name":"admin' > /dev/null
[ $? -eq 0 ] && success || failure
  
for db in sag_tests sag_tests_replication bwah
do
  ((numSteps++))
  echo -e -n "Deleting the $db database...\t\t"
  curl -s -X DELETE http://admin:passwd@localhost:5984/$db > /dev/null
  [ $? -eq 0 ] && success || failure
done

echo -e "\n"

if [ $failures -gt 0 ]
then
  echo "!!! $failures/$numSteps failed. Please resolve and re-run. !!!"
  exit 1
else
  echo "Success!"
fi
